{"version":3,"file":"views.js","sources":["../../../src/js/mixins/view.js","../../../src/js/mixins/views.js"],"sourcesContent":["export default Base => (class extends Base {\n  // Override it with your own initialization logic (like componentDidUnmount in react).\n  initialize(options) {\n  }\n\n  // Override it with your own unmount logic (like componentWillUnmount in react).\n  terminate() {\n  }\n\n  // protected\n\n  constructor(options) {\n    Object.assign(options, Base.dom.data(options.el));\n    super(options);\n    this.reflectOptions(options);\n    this.initializeEvents(options);\n    this.initialize(options);\n    if (NORMAS_DEBUG && this.logging.constructGrouping) {\n      this.log('groupEnd', 'construct');\n    }\n  }\n\n  destructor() {\n    if (NORMAS_DEBUG) {\n      const [destructText, ...destructStyles] = this.constructor.logColor('destructing', 'red');\n      this.log(this.constructor.groupingMethod(this.logging.constructGrouping), 'construct',\n        ...this.constructor.logBold(`${this.logging.constructPrefix} \"%REPLACE%\" ${destructText}`, this.instanceName),\n        ...destructStyles,\n        this);\n    }\n    this.terminate();\n    if (this.listenedEvents) {\n      this.forgetEvents(this.listenedEvents);\n      this.listenedEvents = null;\n    }\n    if (NORMAS_DEBUG && this.logging.constructGrouping) {\n      this.log('groupEnd', 'construct');\n    }\n  }\n\n  reflectOptions(options) {\n    if (!this.constructor.reflectOptions) {\n      return;\n    }\n    Object.keys(options).forEach(attr => {\n      if (this.constructor.reflectOptions.includes(attr)) {\n        this[attr] = options[attr];\n      }\n    });\n  }\n\n  initializeEvents(_options) {\n    const { events } = this.constructor;\n    if (events) {\n      if (!this.linkedEvents) {\n        this.linkedEvents = this.linkEvents(this.helpers.isFunction(events) ? events() : events);\n      }\n      this.listenedEvents = this.listenEvents(this.linkedEvents);\n    }\n  }\n\n  linkEvents(events) {\n    return this.helpers.mapValues(events, handle => this.helpers.isString(handle) ?\n      this[handle].bind(this)\n      :\n      (typeof this.helpers.isPlainObject(handle) ? this.linkEvents(handle) : handle)\n    );\n  }\n\n  data(key, ...value) {\n    this.dom.data(this.el, key, ...value);\n  }\n});\n","/**\n * Views system for Normas\n *\n * @see {@link https://github.com/evrone/normas#-views|Docs}\n * @see {@link https://github.com/evrone/normas/blob/master/src/js/mixins/views.js|Source}\n * @license MIT\n * @copyright Dmitry Karpunin <koderfunk@gmail.com>, 2017-2018\n */\n\n// TODO: may be rename Views, views, View, view\nimport normasView from './view';\n\nexport default Base => normasViews(Base, normasView(Base.NormasCore));\n\n// require content mixin\n// require events mixin\nconst normasViews = (Base, View) => (class extends Base {\n  static View = View;\n  View = View;\n  viewClasses = {};\n  viewInstances = [];\n\n  constructor(options) {\n    super(options);\n    this.viewOptions = {\n      debugMode: this.debugMode,\n      ...options.viewOptions,\n    };\n    if (NORMAS_DEBUG) {\n      this.viewOptions.logging = {\n        ...this.logging,\n        constructGrouping: 'groupCollapsed',\n        constructPrefix: '🏭', // private\n        eventsDebounced: false,\n        ...(options.viewOptions && options.viewOptions.logging),\n      };\n      this.log('info', 'construct', `🏭 \"${this.instanceName}\" views mixin activated.`);\n    }\n  }\n\n  registerView(viewClass, options = {}) {\n    if (this.viewClasses[viewClass.selector]) {\n      if (NORMAS_DEBUG) {\n        this.error(`🏭 View class for selector \\`${viewClass.selector}\\` already registered`,\n          this.viewClasses[viewClass.selector]);\n      }\n      return;\n    }\n    this.viewClasses[viewClass.selector] = viewClass;\n    this.listenToElement(\n      viewClass.selector,\n      $el => this.bindView($el, viewClass, options),\n      $el => this.unbindView($el, viewClass),\n      {\n        delay: viewClass.delay,\n        silent: true,\n      },\n    );\n  }\n\n  bindView($el, viewClass, options) {\n    if (!this.canBind($el, viewClass)) {\n      return null;\n    }\n    if (viewClass.instanceIndex) {\n      viewClass.instanceIndex += 1;\n    } else {\n      viewClass.instanceIndex = 1;\n    }\n    const view = new viewClass({\n      ...this.helpers.deepMerge(this.viewOptions, options),\n      instanceName: `${viewClass.selector}_${viewClass.instanceIndex}`,\n      el: $el[0],\n    });\n    this.viewInstances.push(view);\n    return view;\n  }\n\n  canBind($element, viewClass) {\n    const view = this.getViewsOnElement($element, viewClass)[0];\n    if (view) {\n      if (NORMAS_DEBUG) {\n        this.log('warn', '🏭 Element already has bound view', $element, viewClass, view);\n      }\n      return false;\n    }\n    return true;\n  }\n\n  unbindView($element, viewClass) {\n    const view = this.getViewsOnElement($element, viewClass)[0];\n    if (view) {\n      view.destructor();\n      this.viewInstances = this.helpers.without(this.viewInstances, view);\n    }\n  }\n\n  getViewsOnElement($element, viewClass = null) {\n    const el = $element instanceof $ ? $element[0] : $element;\n    const filterOptions = { el };\n    if (viewClass) {\n      filterOptions.constructor = viewClass;\n    }\n    return this.helpers.filter(this.viewInstances, filterOptions);\n  }\n\n  getViewsInContainer($container, checkRoot = true) {\n    return this.helpers.filter(this.viewInstances, view =>\n      view.$el.closest($container).length > 0 && (checkRoot || view.el !== $container[0])\n    );\n  }\n\n  getAllViews(viewClass) {\n    return this.helpers.filter(this.viewInstances, { constructor: viewClass });\n  }\n\n  getFirstView(viewClass) {\n    return this.helpers.find(this.viewInstances, { constructor: viewClass });\n  }\n\n  getFirstChildView(viewClass) {\n    return this.helpers.find(this.viewInstances, view => view instanceof viewClass);\n  }\n});\n"],"names":["options","assign","Base","dom","data","el","reflectOptions","initializeEvents","initialize","_this","logging","constructGrouping","log","this","constructor","logColor","destructText","destructStyles","groupingMethod","logBold","constructPrefix","instanceName","terminate","listenedEvents","forgetEvents","keys","forEach","_this2","includes","attr","_options","events","linkedEvents","linkEvents","helpers","isFunction","listenEvents","mapValues","_this3","isString","handle","bind","babelHelpers.typeof","isPlainObject","key","value","normasViews","View","viewOptions","debugMode","viewClass","viewClasses","selector","error","listenToElement","bindView","$el","unbindView","delay","canBind","instanceIndex","view","deepMerge","viewInstances","push","$element","getViewsOnElement","destructor","without","filterOptions","$","filter","$container","checkRoot","closest","length","find","normasView","NormasCore"],"mappings":"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"}