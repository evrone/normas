{"version":3,"file":"turbolinks.js","sources":["../../../src/js/mixins/turbolinks.js"],"sourcesContent":["/*!\n * Turbolinks integration for Normas <https://github.com/evrone/normas/blob/master/src/js/mixins/turbolinks.js>\n *\n * @license MIT\n * @copyright Dmitry Karpunin <koderfunk@gmail.com>, 2017-2018\n */\n\n// require navigation mixin\nexport default Base => (class extends Base {\n  static turboPageEnterEventName = 'turbolinks:load';\n  static turboPageLeaveEventName = 'turbolinks:before-cache';\n\n  bindPageEvents(options) {\n    this.Turbolinks = options.Turbolinks || global.Turbolinks;\n    const turbolinksExists = !!this.Turbolinks;\n    if (!this.enablings) this.enablings = {};\n    this.enablings.turbolinks = this.constructor.readOption(options.enablings, 'turbolinks', turbolinksExists);\n    if (this.enablings.turbolinks === true && !turbolinksExists) {\n      this.error('ðŸ›¤ Turbolinks: `option.enablings.turbolinks === true` but `!turbolinksExists`');\n    }\n    this.log('info', 'construct',\n      ...this.constructor.logColor(`ðŸ›¤ \"${this.instanceName}\" Turbolinks %REPLACE%.`,\n        this.enablings.turbolinks ? 'enabled' : 'disabled',\n        this.enablings.turbolinks ? 'green' : 'blue'));\n    if (this.enablings.turbolinks) {\n      // Turbolinks connected :)\n      // patchTurbolinks(this.Turbolinks); // TODO: check versions\n      patchTurbolinksPreviewControl(this.Turbolinks);\n      this.listenEvents(this.constructor.turboPageEnterEventName, this.pageEnter.bind(this));\n      this.listenEvents(this.constructor.turboPageLeaveEventName, this.pageLeave.bind(this));\n      if (options.Turbolinks) {\n        options.Turbolinks.start();\n      }\n    } else {\n      // No Turbolinks ;(\n      const turboNormasImportPath = `normas${process.env.NODE_ENV === 'development' ? '/src/js' : '/dist/js'}`;\n      this.log('warn', 'construct', `ðŸ›¤ You have${this.Turbolinks ? '' : 'n\\'t'} Turbolinks ` +\n        `and use '${turboNormasImportPath}/normasWithTurbolinks', but \\`enablings.turbolinks === false\\`. ` +\n        `Use '${turboNormasImportPath}/normas' instead.`);\n      $(this.pageEnter.bind(this));\n    }\n  }\n\n  visit(location) {\n    if (this.enablings.turbolinks) {\n      this.Turbolinks.visit(location);\n    } else {\n      super.visit(location);\n    }\n  }\n\n  setHash(hash) {\n    if (this.enablings.turbolinks) {\n      let controller = this.Turbolinks.controller;\n      controller.replaceHistoryWithLocationAndRestorationIdentifier(hash, controller.restorationIdentifier);\n    } else {\n      super.setHash(hash);\n    }\n  }\n\n  replaceLocation(url) {\n    if (this.enablings.turbolinks) {\n      this.Turbolinks.controller.replaceHistoryWithLocationAndRestorationIdentifier(url);\n    } else {\n      super.replaceLocation(url);\n    }\n  }\n\n  pushLocation(url) {\n    if (this.enablings.turbolinks) {\n      this.Turbolinks.controller.pushHistoryWithLocationAndRestorationIdentifier(url);\n    } else {\n      super.pushLocation(url);\n    }\n  }\n\n  sayAboutPageLoading(state) {\n    if (this.enablings.turbolinks) {\n      const progressBar = this.Turbolinks.controller.adapter.progressBar;\n      if (state) {\n        progressBar.setValue(0);\n        progressBar.show();\n      } else {\n        progressBar.hide();\n      }\n    } else {\n      super.sayAboutPageLoading(state);\n    }\n  }\n});\n\nfunction patchTurbolinksPreviewControl(Turbolinks) {\n  class OurView extends Turbolinks.View {\n    render({ snapshot, error, isPreview }, callback) {\n      this.markAsPreview(isPreview);\n      if (snapshot) {\n        // added `isPreview` argument\n        this.renderSnapshot(snapshot, isPreview, callback);\n      } else {\n        this.renderError(error, callback);\n      }\n    }\n\n    // added `isPreview` argument\n    renderSnapshot(snapshot, isPreview, callback) {\n      const renderer = new OurSnapshotRenderer(this.getSnapshot(), Turbolinks.Snapshot.wrap(snapshot), isPreview);\n      renderer.delegate = this.delegate;\n      renderer.render(callback);\n    }\n  }\n  Turbolinks.View = OurView;\n\n  class OurSnapshotRenderer extends Turbolinks.SnapshotRenderer {\n    // added `isPreview` argument\n    constructor(currentSnapshot, newSnapshot, isPreview) {\n      super(currentSnapshot, newSnapshot);\n      if (isPreview) {\n        this.newBody = this.newBody.cloneNode(true);\n        this.newBody.isPreview = true;\n      }\n    }\n  }\n}\n\nfunction patchTurbolinks(Turbolinks) {\n  class OurHeadDetails extends Turbolinks.HeadDetails {\n    constructor(...args) {\n      super(...args);\n      this.elements = {};\n      $(this.element).children().each((index, element) => {\n        let key = turboElementToKey(element);\n        if (!this.elements[key]) {\n          this.elements[key] = {\n            type: turboElementType(element),\n            tracked: turboElementIsTracked(element),\n            elements: [],\n          };\n        }\n        this.elements[key].elements.push(element);\n      });\n    }\n    // getTrackedElementSignature() {\n    //   let sign = super.getTrackedElementSignature();\n    //   console.log('sign ', sign);\n    //   return sign;\n    // }\n  }\n  Turbolinks.HeadDetails = OurHeadDetails;\n}\n\n// Injection in Turbolinks.HeadDetails for override this logic:\nfunction turboElementToKey(element) {\n  let url = element.getAttribute('src') || element.getAttribute('href');\n  if (url) {\n    let cuts = url.split('/');\n    cuts = cuts[cuts.length - 1];\n    if (cuts) { url = cuts }\n  }\n  return url || element.outerHTML;\n}\n\nfunction turboElementType(element) {\n  if (turboElementIsScript(element)) {\n    return 'script';\n  } else if (turboElementIsStylesheet(element)) {\n    return 'stylesheet';\n  }\n  return null;\n}\n\nfunction turboElementIsTracked(element) {\n  return element.getAttribute('data-turbolinks-track') === 'reload';\n}\n\nfunction turboElementIsScript(element) {\n  let tagName = element.tagName.toLowerCase();\n  return tagName === 'script';\n}\n\nfunction turboElementIsStylesheet(element) {\n  let tagName = element.tagName.toLowerCase();\n  return tagName === 'style' || (tagName === 'link' && element.getAttribute('rel') === 'stylesheet');\n}\n"],"names":["options","Turbolinks","global","turbolinksExists","enablings","turbolinks","constructor","readOption","error","log","logColor","instanceName","listenEvents","turboPageEnterEventName","pageEnter","bind","turboPageLeaveEventName","pageLeave","start","turboNormasImportPath","process","env","NODE_ENV","location","visit","hash","controller","replaceHistoryWithLocationAndRestorationIdentifier","restorationIdentifier","url","pushHistoryWithLocationAndRestorationIdentifier","state","progressBar","adapter","setValue","show","hide","Base","patchTurbolinksPreviewControl","OurView","callback","snapshot","isPreview","markAsPreview","renderSnapshot","renderError","renderer","OurSnapshotRenderer","getSnapshot","Snapshot","wrap","delegate","render","View","currentSnapshot","newSnapshot","newBody","cloneNode","SnapshotRenderer"],"mappings":"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"}